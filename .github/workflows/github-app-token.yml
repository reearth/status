name: Set GH_PAT Secret Using GitHub App

on:
  schedule:
    - cron: "*/5 * * * *"
  workflow_dispatch:

jobs:
  set-secret:
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: read

    steps:
      - name: Generate installation token
        id: generate-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ vars.GH_APP_ID }}
          private-key: ${{ secrets.GH_APP_PRIVATE_KEY }}

      - name: Set GH_PAT secret using github-script
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.generate-token.outputs.token }}
          script: |
            const crypto = require('crypto');

            const secretName = 'GH_PAT';
            const secretValue = `${{ steps.generate-token.outputs.token }}`;
            const [owner, repo] = process.env.GITHUB_REPOSITORY.split('/');

            // Get the repo public key
            const { data: publicKey } = await github.rest.actions.getRepoPublicKey({
              owner,
              repo
            });

            // Encrypt the secret value
            const keyBytes = Buffer.from(publicKey.key, 'base64');
            const messageBytes = Buffer.from(secretValue);
            const encryptedBytes = crypto.publicEncrypt(
              {
                key: crypto.createPublicKey({
                  key: keyBytes,
                  format: 'der',
                  type: 'spki',
                }),
                padding: crypto.constants.RSA_PKCS1_OAEP_PADDING,
                oaepHash: 'sha256',
              },
              messageBytes
            );
            const encryptedValue = encryptedBytes.toString('base64');

            // Set the repo secret
            await github.rest.actions.createOrUpdateRepoSecret({
              owner,
              repo,
              secret_name: secretName,
              encrypted_value: encryptedValue,
              key_id: publicKey.key_id
            });

            console.log(`âœ… Secret '${secretName}' set successfully.`);
